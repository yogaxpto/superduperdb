<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Sentiment analysis with transformers" href="sentiment_analysis_use_case.html" /><link rel="prev" title="Turn your classical-database into a vector-database with SuperDuperDB" href="compare_vector_search_solutions.html" />

    <!-- Generated with Sphinx 7.1.2 and Furo 2023.07.26 -->
        <title>Multimodal search with CLIP - Python documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css?v=2aa19091" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=36a5483c" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">Python  documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../_static/SuperDuperDB_logo.png" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">Python  documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1 has-children"><a class="reference internal" href="../getting_started/index.html">Getting started</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Getting started</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../getting_started/installation.html">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting_started/minimum_working_example.html">Minimum working example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting_started/features.html">Supported Features</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting_started/faq.html">Frequently asked questions</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../usage/index.html">SuperDuperDB Usage</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of SuperDuperDB Usage</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../usage/db.html">DB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usage/queries.html">Queries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usage/encoders.html">Encoders</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usage/models.html">Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usage/datasets.html">Datasets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usage/vector_index.html">Vector Indexes</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../explanations/index.html">Explanations</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of Explanations</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../explanations/cluster_vs_standalone_mode.html">When to use standalone or cluster mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../explanations/external_data.html">How SuperDuperDB handles external data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../explanations/serialization.html">Serialization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../explanations/versioning.html">Component versioning</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../cluster/index.html">SuperDuperDB Cluster</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of SuperDuperDB Cluster</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../cluster/configuration.html">Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cluster/single_host_cluster.html">SuperDuperDB single host cluster deployment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cluster/architecture.html">SuperDuperDB architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cluster/jobs.html">Jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cluster/change_data_capture.html">Change data capture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cluster/client_server.html">Client-server implementation</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../how_to/index.html">How to …</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of How to …</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../how_to/playground.html">Welcome to the SuperDuperDB Playground!</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how_to/add_images_or_audio.html">Add images, audio or video from URIs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how_to/create_replicaset.html">How to create a replica set in MongoDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how_to/mongo_cdc.html">Perform change data capture (CDC)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how_to/parallelization_on_dask.html">Run computations on Dask</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">Example notebooks</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of Example notebooks</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="mnist_torch.html">Training and maintaining MNIST predictions</a></li>
<li class="toctree-l2"><a class="reference internal" href="mnist_sklearn.html">MNIST using scikit-learn and SuperDuperDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="openai.html">OpenAI vector search</a></li>
<li class="toctree-l2"><a class="reference internal" href="compare_vector_search_solutions.html">Turn your classical-database into a vector-database with SuperDuperDB</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Multimodal search with CLIP</a></li>
<li class="toctree-l2"><a class="reference internal" href="sentiment_analysis_use_case.html">Sentiment analysis with transformers</a></li>
<li class="toctree-l2"><a class="reference internal" href="voice_memos.html">Cataloguing voice-memos for a self managed personal assistant</a></li>
<li class="toctree-l2"><a class="reference internal" href="resnet_features.html">Creating a DB of image features in <code class="docutils literal notranslate"><span class="pre">torchvision</span></code></a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../background/index.html">Background of SuperDuperDB</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle navigation of Background of SuperDuperDB</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../background/our_journey.html">How did we get here?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../background/common_issues.html">Common issues in AI-data development</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../source/modules.html">superduperdb</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle navigation of superduperdb</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../source/superduperdb.html">superduperdb package</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle navigation of superduperdb package</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../source/superduperdb.base.html">superduperdb.base package</a></li>
<li class="toctree-l3"><a class="reference internal" href="../source/superduperdb.cli.html">superduperdb.cli package</a></li>
<li class="toctree-l3"><a class="reference internal" href="../source/superduperdb.container.html">superduperdb.container package</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../source/superduperdb.data.html">superduperdb.data package</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><div class="visually-hidden">Toggle navigation of superduperdb.data package</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../source/superduperdb.data.cache.html">superduperdb.data.cache package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../source/superduperdb.data.tree.html">superduperdb.data.tree package</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../source/superduperdb.db.html">superduperdb.db package</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" role="switch" type="checkbox"/><label for="toctree-checkbox-11"><div class="visually-hidden">Toggle navigation of superduperdb.db package</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../source/superduperdb.db.base.html">superduperdb.db.base package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../source/superduperdb.db.mongodb.html">superduperdb.db.mongodb package</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../source/superduperdb.ext.html">superduperdb.ext package</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" role="switch" type="checkbox"/><label for="toctree-checkbox-12"><div class="visually-hidden">Toggle navigation of superduperdb.ext package</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../source/superduperdb.ext.numpy.html">superduperdb.ext.numpy package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../source/superduperdb.ext.openai.html">superduperdb.ext.openai package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../source/superduperdb.ext.pillow.html">superduperdb.ext.pillow package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../source/superduperdb.ext.sklearn.html">superduperdb.ext.sklearn package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../source/superduperdb.ext.torch.html">superduperdb.ext.torch package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../source/superduperdb.ext.transformers.html">superduperdb.ext.transformers package</a></li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../source/superduperdb.ext.vector.html">superduperdb.ext.vector package</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" role="switch" type="checkbox"/><label for="toctree-checkbox-13"><div class="visually-hidden">Toggle navigation of superduperdb.ext.vector package</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../source/superduperdb.ext.vector.vectors.html">superduperdb.ext.vector.vectors package</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../source/superduperdb.misc.html">superduperdb.misc package</a></li>
<li class="toctree-l3"><a class="reference internal" href="../source/superduperdb.server.html">superduperdb.server package</a></li>
<li class="toctree-l3"><a class="reference internal" href="../source/superduperdb.vector_search.html">superduperdb.vector_search package</a></li>
</ul>
</li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="Multimodal-search-with-CLIP">
<h1>Multimodal search with CLIP<a class="headerlink" href="#Multimodal-search-with-CLIP" title="Permalink to this heading">#</a></h1>
<p>In this notebook we show-case SuperDuperDB’s functionality for searching with multiple types of data over the same <code class="docutils literal notranslate"><span class="pre">VectorIndex</span></code>. This comes out very naturally, due to the fact that SuperDuperDB allows users and developers to add arbitrary models to SuperDuperDB, and (assuming they output vectors) use these models at search/ inference time, to vectorize diverse queries.</p>
<p>To this end, we’ll be using the <a class="reference external" href="https://openai.com/research/clip">CLIP multimodal architecture</a>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>https://github.com/openai/CLIP
</pre></div>
</div>
</div>
<p>So let’s start.</p>
<p>SuperDuperDB supports MongoDB as a databackend. Correspondingly, we’ll import the python MongoDB client <code class="docutils literal notranslate"><span class="pre">pymongo</span></code> and “wrap” our database to convert it to a SuperDuper <code class="docutils literal notranslate"><span class="pre">Datalayer</span></code>:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">clip</span>
<span class="kn">import</span> <span class="nn">pymongo</span>
<span class="kn">from</span> <span class="nn">superduperdb.misc.superduper</span> <span class="kn">import</span> <span class="n">superduper</span>
<span class="kn">from</span> <span class="nn">superduperdb.ext.torch.model</span> <span class="kn">import</span> <span class="n">TorchModel</span>
<span class="kn">from</span> <span class="nn">superduperdb.ext.pillow.image</span> <span class="kn">import</span> <span class="n">pil_image</span> <span class="k">as</span> <span class="n">i</span>
<span class="kn">from</span> <span class="nn">superduperdb.db.mongodb.query</span> <span class="kn">import</span> <span class="n">Collection</span>
<span class="kn">from</span> <span class="nn">superduperdb.container.document</span> <span class="kn">import</span> <span class="n">Document</span> <span class="k">as</span> <span class="n">D</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>

<span class="n">pymongo</span><span class="o">.</span><span class="n">MongoClient</span><span class="p">()</span><span class="o">.</span><span class="n">drop_database</span><span class="p">(</span><span class="s1">&#39;documents&#39;</span><span class="p">)</span>
<span class="n">pymongo</span><span class="o">.</span><span class="n">MongoClient</span><span class="p">()</span><span class="o">.</span><span class="n">drop_database</span><span class="p">(</span><span class="s1">&#39;_filesystem:documents&#39;</span><span class="p">)</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">pymongo</span><span class="o">.</span><span class="n">MongoClient</span><span class="p">()</span><span class="o">.</span><span class="n">documents</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">superduper</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

<span class="n">collection</span> <span class="o">=</span> <span class="n">Collection</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;tiny-imagenet&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
INFO:faiss.loader:Loading faiss.
INFO:faiss.loader:Successfully loaded faiss.
INFO:numexpr.utils:NumExpr defaulting to 8 threads.
</pre></div></div>
</div>
<p>In order to make this notebook easy to execute an play with, we’ll use a sub-sample of the <a class="reference external" href="https://paperswithcode.com/dataset/tiny-imagenet">Tiny-Imagenet dataset</a>.</p>
<p>Everything we are doing here generalizes to much larger datasets, with higher resolution images, without further ado. For such use-cases, however, it’s advisable to use a machine with a GPU, otherwise they’ll be some significant thumb twiddling to do.</p>
<p>To get the images into the database, we use the <code class="docutils literal notranslate"><span class="pre">Encoder</span></code>-<code class="docutils literal notranslate"><span class="pre">Document</span></code> framework. This allows us to save Python class instances as blobs in the <code class="docutils literal notranslate"><span class="pre">Datalayer</span></code>, but retrieve them as Python objects. This makes it far easier to integrate Python AI-models with the datalayer.</p>
<p>To this end, SuperDuperDB contains pre-configured support for <code class="docutils literal notranslate"><span class="pre">PIL.Image</span></code> instances. It’s also possible to create your own encoders.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">superduperdb.container.document</span> <span class="kn">import</span> <span class="n">Document</span> <span class="k">as</span> <span class="n">D</span>
<span class="kn">from</span> <span class="nn">superduperdb.ext.pillow.image</span> <span class="kn">import</span> <span class="n">pil_image</span> <span class="k">as</span> <span class="n">i</span>
<span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">load_dataset</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="n">dataset</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s2">&quot;zh-plus/tiny-imagenet&quot;</span><span class="p">)[</span><span class="s1">&#39;valid&#39;</span><span class="p">]</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="p">[</span><span class="n">D</span><span class="p">({</span><span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">])})</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">]</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING:datasets.builder:Found cached dataset parquet (/Users/dodo/.cache/huggingface/datasets/zh-plus___parquet/Maysee--tiny-imagenet-2eb6c3acd8ebc62a/0.0.0/14a00e99c0d15a23649d0db8944380ac81082d4b021f398733dd84f3a6c569a7)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "087a64e0f9254b629ab6eb3cf77eed5e", "version_major": 2, "version_minor": 0}</script></div>
</div>
<p>The wrapped python dictionaries may be inserted directly to the <code class="docutils literal notranslate"><span class="pre">Datalayer</span></code>:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">collection</span><span class="o">.</span><span class="n">insert_many</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">encoders</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="p">,)))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
INFO:root:found 0 uris
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(&lt;pymongo.results.InsertManyResult at 0x10efdb0d0&gt;,
 TaskWorkflow(database=&lt;superduperdb.db.base.db.DB object at 0x195b4e910&gt;, G=&lt;networkx.classes.digraph.DiGraph object at 0x10f095f10&gt;))
</pre></div></div>
</div>
<p>We can verify that the images are correctly stored:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">collection</span><span class="o">.</span><span class="n">find_one</span><span class="p">())[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
<span class="n">x</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_multimodal_image_search_clip_11_0.png" src="../_images/examples_multimodal_image_search_clip_11_0.png" />
</div>
</div>
<p>We now can wrap the CLIP model, to ready it for multimodel search. It involves 2 components:</p>
<ul class="simple">
<li><p>text-encoding</p></li>
<li><p>visual-encoding</p></li>
</ul>
<p>Once we have installed both parts, we will be able to search with both images and text for matching items:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">superduperdb.ext.torch.tensor</span> <span class="kn">import</span> <span class="n">tensor</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">512</span><span class="p">,))</span>

<span class="n">model</span><span class="p">,</span> <span class="n">preprocess</span> <span class="o">=</span> <span class="n">clip</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;ViT-B/32&quot;</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>

<span class="n">text_model</span> <span class="o">=</span> <span class="n">TorchModel</span><span class="p">(</span>
    <span class="n">identifier</span><span class="o">=</span><span class="s1">&#39;clip_text&#39;</span><span class="p">,</span>
    <span class="nb">object</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
    <span class="n">preprocess</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">clip</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">forward_method</span><span class="o">=</span><span class="s1">&#39;encode_text&#39;</span><span class="p">,</span>
    <span class="n">encoder</span><span class="o">=</span><span class="n">t</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>Let’s verify this works:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">text_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="s1">&#39;this is a test&#39;</span><span class="p">,</span> <span class="n">one</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([ 1.5430e-01,  8.3419e-02, -8.6218e-02, -2.4812e-01, -9.0193e-02,
        -1.7874e-01,  7.9648e-02, -1.4377e+00,  9.5243e-02,  2.9510e-01,
         4.2066e-03,  2.5638e-01, -2.1601e-02,  1.5735e-02,  1.9318e-01,
        -1.6119e-01,  3.6999e-01,  2.2594e-02, -5.7204e-02, -1.9817e-01,
        -7.5301e-03, -3.2254e-01,  2.7348e-01, -3.5396e-01, -1.9037e-01,
         1.0515e-01, -2.4183e-02,  1.0074e-01, -8.8070e-02,  2.6366e-02,
        -2.7968e-01, -2.9460e-01,  2.1931e-02,  1.1822e-01,  8.7239e-02,
         1.1945e-01, -6.0540e-04, -1.0101e-01, -1.0430e-01, -2.0626e-01,
        -1.3790e-01, -3.9173e-02,  7.5546e-03,  1.3866e-01, -1.1169e-01,
         1.1691e-01, -1.8521e-01,  2.9997e-02,  1.0280e-01,  1.1497e-01,
        -1.0389e-01,  5.0075e-02,  3.1277e-01, -1.7357e-01,  4.6908e-02,
        -9.6962e-02,  7.7737e-02,  4.9121e-03, -2.9044e-01, -3.6215e-02,
         3.3161e-01,  4.0403e-02, -3.6717e-02,  3.3114e-02,  1.3841e-01,
         1.1665e-01, -1.8533e-01,  1.4537e-01,  1.7915e-01,  6.0204e-02,
         1.8797e-01, -4.3545e-02, -2.5759e-01,  2.5922e-01, -3.2504e-01,
        -7.3698e-02, -1.3032e-01, -2.1270e-02, -9.7008e-02, -1.5535e-01,
        -1.8003e-01, -2.3091e-01, -7.8064e-02,  2.2982e-01,  3.5198e-02,
         2.6405e-01,  1.8695e-01, -2.9914e-01,  4.2318e-01, -2.0545e-03,
         1.1283e-01, -1.5321e-02, -2.2041e+00,  3.1780e-01,  1.7714e-01,
         1.4387e-01, -2.9230e-01,  7.1942e-02,  1.3914e-01, -2.8608e-01,
         1.8457e-01, -1.0049e-01,  9.6526e-02,  2.8571e-01,  6.4735e-02,
         2.3305e-02, -3.9703e-02, -7.9729e-02, -8.2035e-02,  2.5785e-02,
         1.9965e-02,  4.4991e-01,  2.9948e-02, -1.7797e-02, -1.7955e-02,
        -6.9631e-02,  2.1176e-01, -2.4720e-01, -2.2326e-01,  1.1205e-03,
         1.1491e-01,  2.9441e-02, -1.3374e-01, -1.6872e-01,  1.1021e-01,
        -1.3817e-01,  1.2030e-01,  3.4527e-01,  8.1909e-02,  2.3871e-01,
         2.2229e-01, -1.8966e-01, -2.3539e-01,  8.6902e+00,  1.9549e-01,
         2.1512e-01, -4.9882e-02, -1.1429e-01, -2.2483e-01,  9.4593e-02,
        -7.6711e-02, -9.9087e-02, -6.9110e-02, -1.3233e-01, -3.2581e-01,
         2.7050e-02, -2.4327e-01,  1.1758e-01, -1.4014e-01,  1.9817e-01,
         8.2303e-02, -1.7757e-01, -3.3040e-02, -9.2580e-02,  2.0600e-01,
        -1.3096e-01, -1.4063e-01,  8.7542e-02, -3.2586e-01,  1.9357e-01,
        -2.0348e-01, -3.4610e-01, -7.7105e-02, -4.6517e-02, -2.5897e-01,
         4.9247e-02,  2.1851e-01, -1.3462e-01,  8.5325e-02,  1.0842e-01,
         1.2020e-01, -4.1831e-02,  9.5542e-02,  2.7893e-01, -2.4965e-01,
         9.1718e-02, -1.4164e-01,  3.3395e-01,  1.2548e-01,  4.3229e-02,
        -7.5975e-02,  1.6848e-01, -6.9536e-02,  1.2126e-01, -1.4141e-01,
         1.1193e-01,  1.5343e-01, -9.1195e-03, -3.5644e-01, -4.9832e-02,
         2.1788e-02, -2.5872e-01,  1.0919e-01,  2.7183e-03,  1.9120e-01,
        -1.4926e-01,  3.6027e-02, -1.0323e-01, -2.1820e-01,  6.5567e-02,
         3.0641e-02, -3.5111e-01, -1.7972e-01,  1.1709e-01, -1.1321e-01,
        -1.9422e-01, -1.3823e-02, -1.1502e-01,  1.2422e-01,  2.2445e-02,
         1.4535e-01,  1.8312e-01, -8.5592e-02, -2.4161e-01, -2.3021e-01,
         9.0205e-02, -3.6267e-01, -7.6290e-02,  2.8521e-01,  6.8043e-02,
        -1.6620e-02, -1.3670e-01, -5.1179e-02,  7.4036e-02, -9.4656e-02,
        -2.9560e-03,  7.2101e-02, -1.3797e-02, -7.3376e-02,  1.3650e-03,
         2.2423e-01,  2.5347e-01, -2.9496e-01,  1.7042e-02,  1.9483e-01,
         4.0727e-02, -1.8151e-01,  6.8319e-02, -1.1627e-01,  1.3987e-01,
        -1.2464e-01,  1.6415e-01,  1.1659e-01, -2.9262e-01, -1.3138e-01,
         2.8386e-01,  1.3536e-02,  1.7893e-02,  1.2224e-01, -8.3474e-02,
        -1.8547e-01,  1.3922e-01, -6.6026e-02,  1.8780e-01,  9.8017e-02,
         2.2783e-01,  1.8879e-01, -1.1789e-01,  8.7848e-02,  9.5320e-02,
        -1.3631e-01, -1.2319e-01, -5.0855e-02,  1.7521e-01, -8.8600e-03,
        -2.1211e-01, -1.6603e-01, -9.1632e-02, -1.8940e-01,  1.2483e-01,
        -3.4137e-01,  1.7253e-01, -4.0481e-03, -2.5831e-01,  3.4354e-01,
         7.2386e-02,  6.4229e-02, -1.0345e-01,  8.1469e-02,  1.2823e-01,
         3.0450e-01,  1.2546e-02,  9.2171e-02,  7.6265e-02,  1.9233e-01,
         2.5052e-02,  1.6779e-01, -1.1386e-01, -1.2343e-01,  2.1583e-01,
         5.1995e-02, -1.1094e-01, -1.3655e-01, -2.2207e-02, -4.0817e-02,
        -1.5961e-01, -2.5930e-01, -3.9237e-02,  1.4823e-01,  1.7264e-01,
        -1.0340e-01, -7.3079e-02,  5.3891e-03,  4.6488e-02, -5.2854e-02,
         2.3029e-01,  1.3836e-01, -2.3104e-01,  5.1622e-02, -2.5691e-02,
        -7.3428e-02, -2.0090e-01,  8.6826e+00, -1.3597e-02, -1.5189e-01,
        -2.2824e-02,  1.5231e-01, -1.7320e-01, -6.9214e-02,  1.3925e-02,
         3.7048e-01,  6.3549e-01, -1.1657e-01,  2.5321e-01, -3.9477e-01,
         2.1688e-02,  4.9023e-02, -1.9004e-01,  1.0255e-01, -3.4117e+00,
        -1.6342e-02,  1.7833e-01, -2.9475e-03,  2.0511e-01,  2.2709e-02,
        -1.5878e-01,  4.0416e-01,  2.8988e-01,  1.8286e-01, -8.9414e-02,
         1.9508e-01, -2.8454e-01, -3.6217e-01, -2.0818e-01,  1.3445e-01,
         1.0488e-01,  1.0607e-01, -4.8979e-02,  3.1894e-01,  4.3417e-02,
        -9.3009e-02, -1.1065e-01,  6.5195e-02,  1.7126e-01,  6.9774e-03,
         4.1325e-01,  2.0223e-01,  1.0159e-01, -2.1640e-03,  1.3869e-01,
        -2.3206e-01,  1.6523e-02,  4.7522e-01,  3.5994e-01, -4.1203e-01,
        -3.4080e-02, -1.8557e-01,  2.1812e-01, -1.1671e-01, -1.9644e-01,
         3.0313e-02,  7.6663e-02, -1.4767e-01,  3.0242e-01, -3.8838e-01,
         1.2630e-01,  8.6431e-04, -2.1858e-01, -3.0865e-01, -8.5571e-02,
         4.7795e-03, -1.4999e-01,  1.9752e-02,  1.9733e-01,  8.4233e-02,
        -1.1645e-01, -1.5909e-01, -4.3137e-02, -1.8891e-03, -1.1042e-01,
        -8.6980e-02, -2.1983e-01, -2.5741e-02,  6.9247e-02, -1.7009e-01,
         2.6890e-01, -3.8613e-01, -2.2737e-01,  7.8148e-02, -4.8904e-02,
        -1.5376e-01, -1.6890e-01,  9.6796e-02, -9.0670e-02, -1.9516e-02,
         1.0524e-01,  1.8782e-01,  3.2854e-02,  1.2531e-01, -1.3895e-02,
        -1.0850e-02,  7.8530e-02,  1.2075e-01,  1.0289e-01,  9.0531e-02,
        -1.0503e-01, -1.5543e-02, -1.0592e-01, -5.9506e-02,  4.2483e-01,
        -3.3485e-01, -1.1832e-01, -1.0529e-01,  1.4116e-01,  7.1301e-02,
         2.0267e-01,  1.3006e-01, -4.7153e-02, -1.9340e-01,  9.9480e-02,
         3.2894e-01, -1.5424e-01, -2.4012e-01, -1.7370e-01,  1.0893e-02,
         3.6016e-03, -1.7056e-01, -4.7541e-02,  9.2827e-02, -1.1986e-01,
         9.8331e-03,  1.3779e-02, -1.0578e-01, -1.5484e-04, -1.4863e-02,
         8.7218e-02, -1.3129e-01, -1.6176e-01,  1.8377e-01, -3.2393e-01,
        -6.3812e-02,  1.1426e-01, -3.7811e-01,  1.4901e-01,  1.6303e-01,
        -8.0644e-02, -2.5431e-02,  1.3871e-01, -2.2643e-01, -9.5727e-02,
        -3.8660e-02, -1.0742e-01, -2.5748e-01,  3.4330e-03,  1.8189e-01,
        -4.2146e-02,  9.7470e-03,  4.0985e-02, -1.6121e-01,  1.8116e-01,
         9.7044e-02,  1.7077e-01,  4.1108e-01, -3.9961e-01,  3.8703e-02,
         8.6714e-02,  2.4180e-01,  1.3050e-01, -2.0577e-01,  2.3869e-01,
         7.2552e-02, -9.9135e-01, -2.5906e-02,  3.1244e-01, -9.2438e-02,
        -3.2326e-02,  2.2206e-01,  3.5055e-01,  2.9333e-01, -5.4146e-02,
        -1.0362e-01,  2.1373e-02,  5.3769e-02, -1.9133e-01,  3.8762e-02,
        -1.2608e-01,  2.3885e-01, -2.3160e-01,  3.1447e-01,  2.7911e-01,
        -3.7622e-02, -2.3407e-01,  4.1729e-02,  5.6719e-02, -1.3126e-02,
         1.8311e-01,  6.9699e-03,  1.2088e-01, -2.6926e-01, -4.1645e-02,
         6.8667e-02,  3.4110e-01])
</pre></div></div>
</div>
<p>Similar procedure with the visual part, which takes <code class="docutils literal notranslate"><span class="pre">PIL.Image</span></code> instances as inputs.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">visual_model</span> <span class="o">=</span> <span class="n">TorchModel</span><span class="p">(</span>
    <span class="n">identifier</span><span class="o">=</span><span class="s1">&#39;clip_image&#39;</span><span class="p">,</span>
    <span class="n">preprocess</span><span class="o">=</span><span class="n">preprocess</span><span class="p">,</span>
    <span class="nb">object</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">visual</span><span class="p">,</span>
    <span class="n">encoder</span><span class="o">=</span><span class="n">t</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">visual_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">one</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([ 4.8659e-01,  1.8579e-01, -3.4599e-01,  2.9992e-01, -4.0825e-01,
        -4.1464e-01,  3.4450e-01,  5.6146e-02, -2.4816e-01, -2.3093e-02,
         3.5055e-01, -1.9474e-01,  8.0769e-01, -1.0353e-01, -1.2403e-01,
        -7.9312e-02,  1.4479e+00,  2.1143e-01, -3.2818e-02,  7.0584e-02,
        -6.5244e-01,  1.2944e-01,  1.6678e-01, -2.6070e-01, -3.2287e-01,
         3.0141e-01, -2.1176e-01,  9.4882e-02,  1.6218e-01, -5.0878e-02,
         2.0792e-01, -2.2583e-01,  3.8166e-01,  1.5090e-01,  5.0803e-01,
        -2.2024e-01, -9.4464e-02, -3.9695e-01, -5.3257e-01,  1.5086e+00,
         4.8122e-01, -1.5022e-01, -2.9540e-01,  1.4052e-01,  1.5982e-01,
         1.9730e+00,  3.4827e-01,  2.0014e-01,  4.0259e-01, -2.0694e-01,
        -2.3321e-01,  4.5839e-01, -4.1365e-01, -4.2055e-02,  1.3702e-01,
         3.4278e-01,  3.0134e-01, -2.3013e-02, -2.1060e-01, -3.1676e-02,
        -3.3171e-01, -1.5272e-01, -1.0102e-01, -1.3582e-01, -4.4713e-02,
        -1.1459e-01, -1.0656e-01,  1.1455e+00,  2.9830e-01, -5.2836e-01,
         1.1615e-01,  4.1059e-02, -5.2280e-02, -1.2230e-01,  1.0334e-01,
        -2.9715e-01,  9.7823e-02,  1.2846e-01, -1.0330e-01,  4.0708e-01,
         2.0693e-01,  8.1274e-02,  1.3433e-01, -6.1875e-01,  5.6298e-01,
        -2.9570e-02, -3.6324e-01, -4.3506e-01, -4.4713e-01, -8.9488e-02,
         5.7325e-02, -3.8107e-01, -8.0069e+00, -5.7182e-01,  1.4304e-01,
         1.4258e-02, -4.0054e-01, -1.2769e-01, -2.7697e-01,  8.8488e-02,
         1.2445e-02,  8.3826e-02,  2.4816e-01,  7.4373e-03,  3.8211e-01,
        -4.7244e-01, -4.3356e-01,  1.5694e-01,  1.1457e-01,  2.0866e-01,
        -1.6005e-01,  1.2338e-01, -3.2568e-02,  1.2550e-01, -1.4431e-01,
        -1.9869e-01, -9.3804e-02, -6.3201e-02,  2.2538e-02, -3.4366e-01,
        -4.4233e-01,  4.6782e-01,  1.9964e-01,  2.3947e-02,  7.3856e-02,
         8.7400e-01,  1.2871e-01,  2.1497e-01, -1.8266e-02,  1.3739e-01,
         1.6984e-01,  4.5703e-01,  3.1141e-01,  1.0004e+00,  3.8233e-01,
         6.3598e-01, -4.1510e-02,  9.9970e-03, -2.4481e-01,  2.2672e-01,
        -3.0478e-01, -3.3055e-01, -1.5140e-02, -2.2742e-01,  2.2997e-01,
        -3.1292e-01,  8.5402e-02, -2.5946e-01,  3.0176e-01, -5.8103e-02,
         1.1826e-01, -4.2911e-01,  1.0258e+00,  7.1014e-01, -1.8818e-01,
        -3.6742e-01, -5.9284e-01,  4.9751e-01, -3.4304e-01,  4.4528e-02,
        -3.5134e-01, -2.9965e-01, -5.9763e-02, -2.0232e-02, -1.5396e-01,
        -4.7703e-02, -8.6189e-02, -3.5100e-01, -2.2760e-01, -2.4721e-01,
         5.4972e-01, -8.0570e-02, -1.3090e-01, -4.3534e-01,  4.4065e-01,
        -2.9047e-01, -1.3621e-01,  3.7583e-01,  9.9364e-01, -1.1233e-01,
        -2.4568e-01, -9.9726e-03, -6.6678e-01,  1.3360e-02, -3.5559e-01,
         1.3786e-01,  5.4628e-01,  9.5797e-02, -3.6925e-02, -1.1009e-01,
        -3.5624e-01,  3.0587e-01, -3.0540e-01, -2.1706e-01,  3.8220e-01,
        -4.5234e-02, -1.0605e-01, -3.3400e-01, -2.4744e-01, -4.2654e-01,
         2.8152e-01,  9.1575e-03,  3.2901e-01,  4.7117e-01, -7.5717e-02,
         3.6096e-01, -6.4893e-01, -8.3752e-02,  7.5458e-01, -5.0178e-01,
        -2.5218e-01,  9.1638e-02, -3.2760e-01,  3.5809e-01, -1.5612e-01,
         2.3451e-01, -3.5299e-01,  2.0313e-01,  6.9436e-01,  2.0766e-01,
         1.4271e-01,  1.0017e+00,  1.6497e-01,  2.1219e-01, -1.3893e-01,
        -1.4154e-02, -1.4199e-01,  2.6117e-01,  9.8827e-02, -5.3863e-02,
        -6.8279e-02,  2.1678e-01,  1.2274e-01,  2.6358e-01,  4.5773e-02,
        -4.8226e-01, -5.0038e-01, -1.2144e-01,  5.8695e-02,  2.4586e-01,
        -3.0351e-01,  3.3064e-02, -3.2126e-01,  2.8273e-02,  4.8996e-02,
         6.3899e-02, -6.3606e-02,  6.1585e-02,  8.6193e-02,  9.6659e-02,
         5.4653e-01,  2.0406e-02,  4.4253e-01, -2.4859e-01, -1.6561e-01,
         1.0863e-01,  4.3434e-01,  9.7059e-02, -5.4826e-01, -7.3813e-01,
         1.9771e-01, -3.7523e-01, -3.4789e-02, -1.3805e+00, -8.4889e-02,
         6.6064e-02,  1.1166e-02, -8.3336e-02,  2.2525e-01, -9.7703e-01,
         3.4624e-01,  4.4169e-01, -8.9524e-01,  6.3850e-02,  6.0194e-02,
         2.1283e-03,  1.9266e-01, -1.4074e-01, -2.6035e-01, -8.6531e-03,
         5.2937e-02, -2.3509e-01, -4.6994e-01,  1.6480e-01, -1.1773e-02,
        -1.7236e-01,  8.3237e-01,  4.3006e-02, -2.5157e-01, -2.3946e-01,
         1.1590e-01,  3.7779e-01,  5.4778e-02, -1.9815e-01, -3.4478e-01,
         6.6407e-02,  2.0775e-01, -1.4578e-01, -5.2640e-01,  1.2391e-01,
         1.7739e-02, -1.9729e-01,  3.8325e-01,  4.0519e-01, -2.9411e-01,
        -6.5148e-01,  1.2031e-01,  5.9977e-02, -1.5699e-01,  2.5243e-01,
         2.2692e-01, -2.0737e-01,  9.9998e-01, -8.7409e-01,  1.9896e-01,
         3.1460e-01,  5.6703e-01,  3.5409e-01, -1.9336e-01, -7.8530e-01,
         2.7292e-01, -6.2440e-01, -7.9900e-01, -1.0640e-01,  3.2227e-01,
        -3.5777e-02, -1.9243e-01, -1.2465e-01,  2.1445e-01,  3.9889e-01,
         1.3695e-01,  1.3896e-01,  5.5686e-01, -2.9277e-01,  4.2486e-01,
        -2.0177e-01, -1.4167e-01,  5.7479e-01,  5.7593e-01,  1.0930e-01,
         2.2963e-01,  4.0391e-01, -3.2336e-01, -5.2913e-02,  6.4116e-02,
        -1.9256e-02,  8.9602e-02, -4.3330e-02,  7.5682e-02,  4.2662e-01,
         8.9902e-01,  5.4406e-02,  6.2682e-01,  5.3460e-02,  1.6013e-01,
         5.0503e-01, -7.0391e-02,  4.9794e-01,  3.6999e-01, -2.8241e-01,
         3.5041e-01, -1.9724e-01, -3.6881e-02,  2.5877e-01, -7.4035e-01,
         2.0962e-01, -1.3104e-01,  3.6532e-01, -5.2135e-01, -1.1576e-01,
         5.8701e-02,  9.5386e-02,  2.3154e-01, -2.3241e-01, -5.3956e-01,
         1.4103e-01, -3.6637e-01, -1.3619e-01, -4.3604e-01, -3.5766e-02,
         6.8452e-02, -4.7673e-01, -8.4256e-01, -5.5939e-01,  4.0212e-01,
        -2.0992e-01,  3.8594e-01,  2.1925e-01,  8.3436e-02, -7.3254e-01,
        -9.6499e-01, -4.1649e-01, -2.9435e-02,  1.3345e-01, -1.7249e-01,
         2.4390e-01, -2.6096e-01, -2.4066e-01,  3.3974e-02, -1.0788e+00,
        -7.9467e-02,  1.8561e-01, -1.1641e-01,  6.3469e-02, -3.6187e-01,
        -4.3277e-01, -2.8813e-01, -3.1252e-01, -1.6355e-01,  2.8944e-02,
         2.7541e-01,  6.2331e-03,  2.0263e-01,  5.8527e-01,  1.0387e-01,
         5.4915e-02, -3.3509e-01, -6.5902e-01, -5.9526e-01, -9.0609e-02,
         2.4145e-02,  3.2513e-01, -2.5665e-01, -5.4765e-02, -1.2333e-01,
         3.8732e-01,  5.4573e-01, -6.3007e-02, -4.1968e-02, -6.6151e-01,
         3.2343e-01,  4.2862e-01, -8.0447e-02, -6.6625e-02, -2.4751e-01,
        -1.1305e-01,  3.6587e-01,  4.2348e-01, -6.6336e-02, -1.2690e-01,
         5.4302e-02,  2.2723e-01,  1.4896e-01,  1.9307e-01,  8.3279e-02,
         9.8979e-02,  8.7400e-02,  2.5592e-01, -2.6584e-01, -8.4253e-01,
        -9.6982e-01, -1.5401e-01, -1.6048e-01, -1.0966e-01, -3.8056e-02,
         2.4241e-01,  3.7506e-02, -1.0273e-01,  2.9826e-01, -3.3949e-01,
         3.1233e-01, -1.6339e-01, -1.2012e-01, -5.9874e-01,  3.6827e-01,
        -4.5493e-02,  1.7017e-01,  6.3561e-02, -3.8529e-02, -1.6421e-01,
         3.3156e-01,  2.6218e-01,  1.7616e-01, -2.9402e-01,  9.3635e-02,
         6.1420e-02,  1.9928e-01,  2.1918e-02, -2.9795e-02,  5.7445e-01,
         3.4429e-01, -2.9797e-01, -9.6351e-02, -1.0312e-01, -5.5581e-01,
        -2.1043e-02,  3.5552e-01,  1.7819e-01, -8.3266e-02, -3.0401e-02,
         8.4081e-02,  3.4726e-01, -1.2827e-01, -1.0422e-01,  6.9640e-02,
         1.9173e-01, -4.1692e-01, -2.5102e-01, -1.2409e-01, -6.6348e-02,
        -3.5595e-01,  5.3352e-02,  2.9619e-01,  1.9629e-02, -4.9146e-01,
         9.7190e-03,  1.7677e-01,  3.5836e-01,  7.5639e-03,  1.2878e+00,
         2.3495e-01, -4.1232e-02])
</pre></div></div>
</div>
<p>Now let’s create the index for searching by vector. We register both models with the index simultaneously, but specifying that it’s the <code class="docutils literal notranslate"><span class="pre">visual_model</span></code> which will be responsible for creating the vectors in the database (<code class="docutils literal notranslate"><span class="pre">indexing_listener</span></code>). The <code class="docutils literal notranslate"><span class="pre">compatible_listener</span></code> specifies how one can use an alternative model to search the vectors. By using models which expect different types of index, we can implement multimodal search without further ado.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">superduperdb.container.vector_index</span> <span class="kn">import</span> <span class="n">VectorIndex</span>
<span class="kn">from</span> <span class="nn">superduperdb.container.listener</span> <span class="kn">import</span> <span class="n">Listener</span>

<span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
    <span class="n">VectorIndex</span><span class="p">(</span>
        <span class="s1">&#39;my-index&#39;</span><span class="p">,</span>
        <span class="n">indexing_listener</span><span class="o">=</span><span class="n">Listener</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">visual_model</span><span class="p">,</span>
            <span class="n">key</span><span class="o">=</span><span class="s1">&#39;image&#39;</span><span class="p">,</span>
            <span class="n">select</span><span class="o">=</span><span class="n">collection</span><span class="o">.</span><span class="n">find</span><span class="p">(),</span>
        <span class="p">),</span>
        <span class="n">compatible_listener</span><span class="o">=</span><span class="n">Listener</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">text_model</span><span class="p">,</span>
            <span class="n">key</span><span class="o">=</span><span class="s1">&#39;text&#39;</span><span class="p">,</span>
            <span class="n">active</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING:root:model/clip_image/0 already exists - doing nothing
WARNING:root:model/clip_image/0 already exists - doing nothing
100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 1000/1000 [04:38&lt;00:00,  3.59it/s]
WARNING:root:encoder/torch.float32[512]/0 already exists - doing nothing
INFO:root:loading hashes: &#39;my-index&#39;
/Users/dodo/SuperDuperDB/superduperdb/superduperdb/ext/torch/tensor.py:26: UserWarning: The given NumPy array is not writable, and PyTorch does not support non-writable tensors. This means writing to this tensor will result in undefined behavior. You may want to copy the array to protect its data or make it writable before converting it to a tensor. This type of warning will be suppressed for the rest of this program. (Triggered internally at /Users/runner/work/pytorch/pytorch/pytorch/torch/csrc/utils/tensor_numpy.cpp:212.)
  return torch.from_numpy(array)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[]
</pre></div></div>
</div>
<p>We can now demonstrate searching by text for images:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">out</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="n">collection</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="n">D</span><span class="p">({</span><span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;mushroom&#39;</span><span class="p">}),</span> <span class="n">vector_index</span><span class="o">=</span><span class="s1">&#39;my-index&#39;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">({})</span>
<span class="p">)</span>
<span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
    <span class="n">display</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
INFO:root:loading hashes: &#39;my-index&#39;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_multimodal_image_search_clip_22_1.png" src="../_images/examples_multimodal_image_search_clip_22_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_multimodal_image_search_clip_22_2.png" src="../_images/examples_multimodal_image_search_clip_22_2.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_multimodal_image_search_clip_22_3.png" src="../_images/examples_multimodal_image_search_clip_22_3.png" />
</div>
</div>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="sentiment_analysis_use_case.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Sentiment analysis with transformers</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="compare_vector_search_solutions.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Turn your classical-database into a vector-database with SuperDuperDB</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; SuperDuperDB Inc., opensource@superduperdb.com
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../_static/scripts/furo.js?v=32e29ea5"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    </body>
</html>